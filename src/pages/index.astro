---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import ContactSection from '../components/ContactSection.astro';
import AgendaSection from '../components/sections/AgendaSection.astro';
import AboutSection from '../components/sections/AboutSection.astro';
import GallerySection from '../components/sections/GallerySection.astro';
import TallerCard from '../components/TallerCard.astro';
import ComunidadCard from '../components/ComunidadCard.astro';
import { getCollection } from 'astro:content';
import siteSettings from '../content/settings/site.json';

// Obtener datos
const talleres = (await getCollection('talleres'))
  .filter(taller => taller.data.activo)
  .sort((a, b) => a.data.orden - b.data.orden);
const comunidad = (await getCollection('comunidad'))
  .filter(item => item.data.destacado)
  .sort((a, b) => a.data.orden - b.data.orden);

// Obtener eventos próximos para Schema dinámico
const ahora = new Date();
const eventosProximos = (await getCollection('agenda'))
  .filter(evento => new Date(evento.data.fecha) > ahora && evento.data.estado !== 'Finalizado' && evento.data.estado !== 'Suspendido')
  .sort((a, b) => new Date(a.data.fecha).getTime() - new Date(b.data.fecha).getTime())
  .slice(0, 5); // Máximo 5 eventos para Schema
---

<Layout title="CIArte – El Laberinto | Espacio de Arte Comunitario">
  <main>
    <Hero />

    <!-- SECCIÓN QUÉ ES CIARTE -->
    <AboutSection />

    <!-- SECCIÓN AGENDA -->
    <section class="reveal">
      <AgendaSection />
    </section>



    <!-- SECCIÓN TALLERES -->
    <section class="section bg-light reveal" id="talleres">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">Nuestros Talleres</h2>
          <p class="section-subtitle">
            Espacios de aprendizaje y creación para todas las edades. ¡Sumate!
          </p>
        </div>

        <div class="grid-3">
          {talleres.map(taller => (
            <TallerCard taller={taller} />
          ))}
        </div>
      </div>
    </section>

    <!-- SECCIÓN COMUNIDAD / AGENDA -->
    <section class="section reveal" id="comunidad">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">Vida Comunitaria</h2>
          <p class="section-subtitle">
            Más allá de los talleres, compartimos encuentros, celebraciones y proyectos colectivos.
          </p>
        </div>

        <div class="grid-3">
          {comunidad.map(actividad => (
            <ComunidadCard actividad={actividad} />
          ))}
        </div>
      </div>
    </section>

    <!-- SECCIÓN GALERÍA -->
    <section class="reveal">
      <GallerySection />
    </section>

    <div class="reveal">
      <ContactSection />
    </div>
  </main>
  
  <script type="application/ld+json" is:inline set:html={JSON.stringify(
    eventosProximos.length > 0 ? eventosProximos.map(evento => ({
      "@context": "https://schema.org",
      "@type": "Event",
      "name": evento.data.titulo,
      "startDate": new Date(evento.data.fecha).toISOString(),
      "eventStatus": evento.data.estado === 'Suspendido' 
        ? "https://schema.org/EventCancelled" 
        : "https://schema.org/EventScheduled",
      "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
      "location": {
        "@type": "Place",
        "name": evento.data.lugar || "CIArte - El Laberinto",
        "address": {
          "@type": "PostalAddress",
          "streetAddress": siteSettings.direccion,
          "addressLocality": "General Güemes",
          "addressRegion": "Salta",
          "addressCountry": "AR"
        }
      },
      "description": evento.data.descripcion,
      "organizer": {
        "@type": "Organization",
        "name": "CIArte – El Laberinto",
        "url": "https://ciarte-ellaberinto.netlify.app"
      },
      "offers": evento.data.precio ? {
        "@type": "Offer",
        "price": evento.data.precio,
        "priceCurrency": "ARS",
        "availability": "https://schema.org/InStock"
      } : undefined
    })) : []
  )} />
</Layout>

<style>
  .text-left { text-align: left; }
  
  /* Mobile: Center title */
  @media (max-width: 768px) {
    .section-title.text-left {
      text-align: center;
    }
    
    .about-content {
      text-align: center;
    }
  }
  
  .text-primary { color: var(--color-primary-500); }
  .bg-light { background-color: var(--color-neutral-50); }
  
  .bg-dark { background-color: var(--color-primary-900); }
  .text-white { color: white !important; }
  .text-white-50 { color: rgba(255,255,255,0.7) !important; }

  .about-section {
    padding-top: var(--space-12);
  }

  @media (min-width: 768px) {
    .about-section {
      padding-top: var(--space-20);
    }
  }

  #agenda {
    padding-top: var(--space-10); /* Reducir espacio superior */
  }

  .lead {
    font-size: var(--font-size-xl);
    font-weight: 500;
    color: var(--color-text-primary); /* White text for dark background */
    margin-bottom: var(--space-6);
    line-height: var(--line-height-relaxed);
  }

  .rounded-image {
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    transform: rotate(2deg);
    border: 8px solid white;
    max-height: 400px;
    object-fit: cover;
    width: 100%;
  }

  .about-grid {
    align-items: center;
  }

  /* Gallery Grid Mosaic */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(3, 200px);
    gap: var(--space-4);
  }

  @media (min-width: 768px) {
    .gallery-grid {
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, 250px);
    }
  }

  .gallery-item {
    overflow: hidden;
    border-radius: var(--radius-lg);
    position: relative;
  }
  
  .agenda-card .card-image {
    aspect-ratio: 4/5; /* Formato flyer vertical */
    overflow: hidden;
    background-color: var(--color-neutral-900); /* Fondo oscuro para el relleno */
  }

  .agenda-card .card-image img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Mostrar imagen completa */
    transition: transform 0.5s ease;
  }

  .agenda-card:hover .card-image img {
    transform: scale(1.03);
  }

  .agenda-card .card-content {
    padding: var(--space-4);
    background-color: var(--color-surface);
  }

  .agenda-card .card-title {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-2);
  }
  
  .mt-4 { margin-top: var(--space-4); }

  .btn-outline {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--color-accent-400);
    color: var(--color-accent-400);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    transition: all 0.3s;
    text-align: center;
  }

  .btn-outline:hover {
    background-color: var(--color-accent-400);
    color: var(--color-neutral-900);
  }

  .centered-btn {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: fit-content;
    min-width: 200px;
  }
  
  .gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .gallery-item:hover img {
    transform: scale(1.1);
  }

  .item-1 { grid-area: 1 / 1 / 3 / 3; } /* Large item */

  .placeholder-gallery {
    width: 100%;
    height: 100%;
    background-color: rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
</style>
