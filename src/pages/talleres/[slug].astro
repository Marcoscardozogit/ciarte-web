---
import Layout from '../../layouts/Layout.astro';
import TallerCard from '../../components/TallerCard.astro';
import { getCollection } from 'astro:content';

import { Image } from 'astro:assets';
import defaultImage from '../../assets/images/hero-bg.jpg'; // Using hero-bg as default since default-taller not found

export async function getStaticPaths() {
  const talleres = await getCollection('talleres');
  const activeTalleres = talleres.filter(taller => taller.data.activo);
  
  return activeTalleres.map(taller => ({
    params: { slug: taller.slug },
    props: { taller },
  }));
}

const { taller } = Astro.props;
const { Content } = await taller.render();

const tallerNavItems = [
  { label: 'Volver', href: '/#talleres' },
  { label: 'Inscripción', href: '#inscripcion' },
  { label: 'Docente', href: '#docente' },
  { label: 'Galería', href: '#galeria' },
];

const bgImage = taller.data.flyer?.src || taller.data.imagen?.src || defaultImage.src;

// Resolver datos del docente
import { getEntry } from 'astro:content';
let docenteNombre = taller.data.docente_nombre;
let docenteBio = taller.data.docente_bio;
let docenteFoto = taller.data.docente_foto;

if (taller.data.docente) {
  const docenteEntry = await getEntry(taller.data.docente);
  if (docenteEntry) {
    docenteNombre = docenteEntry.data.nombre;
    docenteBio = docenteEntry.data.bio;
    docenteFoto = docenteEntry.data.foto;
  }
}

// Resolver WhatsApp
import siteSettings from '../../content/settings/site.json';
const whatsappNumber = taller.data.whatsapp_custom || siteSettings.whatsapp;

---

<Layout title={`${taller.data.titulo} | CIArte`} description={taller.data.meta_description || taller.data.descripcion} image={bgImage} navItems={tallerNavItems}>
  <article class="taller-detail">
    <header class="taller-header">
      <div class="container header-content">
        <h1 class="taller-title">{taller.data.titulo}</h1>
        <div class="taller-meta">
          <span class="badge">{taller.data.edadNivel}</span>
          <span class="badge secondary">{taller.data.horarios}</span>
        </div>
      </div>
      <div class="header-bg" style={`background-image: url(${bgImage})`}></div>
      <div class="header-overlay"></div>

      <!-- Schema Course + Breadcrumb -->
      <script type="application/ld+json" is:inline set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "Course",
            "name": taller.data.titulo,
            "description": taller.data.descripcion,
            "provider": {
              "@type": "Organization",
              "@id": "https://ciarte-ellaberinto.netlify.app/#organization",
              "name": "CIArte – El Laberinto"
            },
            "hasCourseInstance": {
              "@type": "CourseInstance",
              "courseMode": "onsite",
              "courseWorkload": taller.data.horarios,
              "instructor": docenteNombre ? {
                "@type": "Person",
                "name": docenteNombre
              } : undefined,
              "location": {
                "@type": "Place",
                "name": "CIArte",
                "address": {
                  "@type": "PostalAddress",
                  "addressLocality": "General Güemes",
                  "addressRegion": "Salta",
                  "addressCountry": "AR"
                }
              }
            },
            "audience": {
              "@type": "Audience",
              "audienceType": taller.data.edadNivel
            }
          },
          {
            "@type": "BreadcrumbList",
            "itemListElement": [
              {
                "@type": "ListItem",
                "position": 1,
                "name": "Inicio",
                "item": "https://ciarte-ellaberinto.netlify.app/"
              },
              {
                "@type": "ListItem",
                "position": 2,
                "name": "Talleres",
                "item": "https://ciarte-ellaberinto.netlify.app/#talleres"
              },
              {
                "@type": "ListItem",
                "position": 3,
                "name": taller.data.titulo,
                "item": `https://ciarte-ellaberinto.netlify.app/talleres/${taller.slug}`
              }
            ]
          }
        ]
      })} />
    </header>

    <div class="container content-container">
      <!-- Breadcrumbs Visibles -->
      <nav class="breadcrumbs" aria-label="Navegación de migas de pan">
        <ol>
          <li><a href="/">Inicio</a></li>
          <li><a href="/#talleres">Talleres</a></li>
          <li aria-current="page">{taller.data.titulo}</li>
        </ol>
      </nav>

      <div class="grid-layout">
        <div class="main-content">
          <div class="prose">
            <Content />
          </div>
        </div>

        <aside class="sidebar" id="inscripcion">
          <div class="info-card">
            <h3>Detalles</h3>
            <ul class="info-list">
              <li>
                <strong>Horario:</strong>
                <span>{taller.data.horarios}</span>
              </li>
              <li>
                <strong>Público:</strong>
                <span>{taller.data.edadNivel}</span>
              </li>
              {docenteNombre && (
                <li>
                  <strong>Docente:</strong>
                  <span>{docenteNombre}</span>
                </li>
              )}
            </ul>
            <div class="actions">
              <a 
                href={`https://wa.me/${whatsappNumber}?text=Hola, quiero inscribirme en el taller de ${taller.data.titulo}`} 
                class="btn btn-primary full-width"
                target="_blank"
              >
                Inscribirme
              </a>
            </div>
          </div>
        </aside>
      </div>

      {docenteNombre && (
        <section class="docente-section" id="docente">
          <h2 class="docente-title">Sobre el Docente</h2>
          <div class="docente-card">
             <div class="docente-avatar">
                {docenteFoto ? (
                  <Image src={docenteFoto} alt={docenteNombre} />
                ) : (
                  <span>{docenteNombre.charAt(0)}</span>
                )}
             </div>
             <div class="docente-info">
               <h3>{docenteNombre}</h3>
               <p>{docenteBio}</p>
             </div>
          </div>
        </section>
      )}

      {taller.data.galeria && taller.data.galeria.length > 0 && (
        <section class="taller-gallery" id="galeria">
          <h2 class="gallery-title">Galería del Taller</h2>
          <div class="gallery-grid">
            {taller.data.galeria.map(item => {
              const img = item.image || item; // Support object or direct image
              const alt = item.alt || `Imagen del taller de ${taller.data.titulo}`;
              return (
              <div class="gallery-item">
                <a href={img.src} data-lightbox data-caption={alt} aria-label="Ver imagen completa">
                  <Image src={img} alt={alt} />
                </a>
              </div>
            )})}
          </div>
        </section>
      )}
      </div>
    </div>
  </article>
</Layout>

<style>
  .taller-header {
    position: relative;
    padding-top: 280px;
    padding-bottom: 80px;
    color: white;
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .nav-back {
    margin-bottom: var(--space-4);
  }

  .back-link {
    display: inline-block;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
    background: rgba(0,0,0,0.3);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    backdrop-filter: blur(4px);
  }

  .back-link:hover {
    color: white;
    background: rgba(0,0,0,0.5);
  }

  .header-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--color-primary-900);
    background-size: cover;
    background-position: center;
    z-index: -2;
  }

  .header-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.8));
    backdrop-filter: blur(2px);
    z-index: -1;
  }

  .header-content {
    position: relative;
    z-index: 1;
  }

  .taller-title {
    font-size: var(--font-size-5xl);
    margin-bottom: var(--space-6);
  }

  .taller-meta {
    display: flex;
    gap: var(--space-3);
    justify-content: center;
    flex-wrap: wrap;
  }

  .badge {
    background-color: var(--color-primary-500);
    color: white;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-weight: bold;
    font-size: var(--font-size-sm);
  }

  .badge.secondary {
    background-color: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.4);
  }

  .grid-layout {
    display: grid;
    gap: var(--space-8);
  }

  @media (min-width: 768px) {
    .grid-layout {
      grid-template-columns: 2fr 1fr;
    }
  }

  .prose {
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
  }

  .prose h2 {
    color: var(--color-primary-700);
    margin-top: var(--space-8);
    margin-bottom: var(--space-4);
  }

  .prose ul {
    list-style: disc;
    padding-left: var(--space-6);
    margin-bottom: var(--space-6);
  }

  .info-card {
    background-color: var(--color-surface); /* Dark background */
    padding: var(--space-6);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
    position: sticky;
    top: 100px;
    box-shadow: var(--shadow-md);
  }

  .info-card h3 {
    color: var(--color-primary-500); /* Red Title */
    margin-bottom: var(--space-4);
    border-bottom: 2px solid var(--color-primary-900);
    padding-bottom: var(--space-2);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .info-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .info-list li {
    display: flex;
    flex-direction: column;
    border-bottom: 1px solid var(--color-neutral-800);
    padding-bottom: var(--space-2);
  }
  
  .info-list li:last-child {
    border-bottom: none;
  }

  .info-list strong {
    color: var(--color-accent-400); /* Gold Label */
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    margin-bottom: var(--space-1);
    font-weight: bold;
  }
  
  .info-list span {
    color: var(--color-text-primary); /* White Text */
    font-size: var(--font-size-lg);
  }

  .full-width {
    width: 100%;
    text-align: center;
  }

  .taller-gallery {
    margin-top: var(--space-12);
    padding-top: var(--space-8);
    border-top: 1px solid var(--color-neutral-200);
  }

  .gallery-title {
    font-size: var(--font-size-2xl);
    color: var(--color-neutral-100);
    margin-bottom: var(--space-6);
    text-align: center;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-4);
  }

  @media (min-width: 768px) {
    .gallery-grid {
        grid-template-columns: repeat(2, 1fr);
    }
  }

  .gallery-item {
    border-radius: var(--radius-lg);
    overflow: hidden;
    aspect-ratio: 4/3;
    box-shadow: var(--shadow-md);
  }

  .gallery-item a {
    display: block;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .gallery-item:hover img {
    transform: scale(1.05);
  }

  /* Sección Docente */
  .docente-section {
    margin-top: var(--space-8);
    margin-bottom: var(--space-8);
    background-color: var(--color-surface);
    padding: var(--space-6);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
  }

  .docente-title {
    font-size: var(--font-size-xl);
    color: var(--color-primary-500);
    margin-bottom: var(--space-6);
    border-bottom: 2px solid var(--color-primary-900);
    padding-bottom: var(--space-2);
    display: inline-block;
  }

  .docente-card {
    display: flex;
    gap: var(--space-6);
    align-items: center;
  }

  .docente-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: var(--color-primary-800);
    color: var(--color-accent-400);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    flex-shrink: 0;
    overflow: hidden;
    border: 2px solid var(--color-accent-400);
  }

  .docente-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .docente-info h3 {
    color: white;
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-2);
  }

  .docente-info p {
    color: var(--color-neutral-300);
  }

  /* Breadcrumbs Visibles */
  .breadcrumbs {
    margin-bottom: var(--space-6);
    padding: var(--space-3) 0;
  }

  .breadcrumbs ol {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .breadcrumbs li {
    display: flex;
    align-items: center;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .breadcrumbs li:not(:last-child)::after {
    content: '/';
    margin-left: var(--space-2);
    color: var(--color-neutral-500);
  }

  .breadcrumbs a {
    color: var(--color-accent-400);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .breadcrumbs a:hover {
    color: var(--color-accent-300);
    text-decoration: underline;
  }

  .breadcrumbs [aria-current="page"] {
    color: var(--color-text-primary);
    font-weight: var(--font-weight-medium);
  }

  /* Mejoras Responsive para Tablets (640px - 1023px) */
  @media (min-width: 640px) and (max-width: 1023px) {
    .grid-layout {
      grid-template-columns: 1fr;
      gap: var(--space-6);
    }

    .info-card {
      position: static;
    }

    .taller-title {
      font-size: var(--font-size-4xl);
    }

    .docente-card {
      flex-direction: column;
      text-align: center;
    }

    .gallery-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
