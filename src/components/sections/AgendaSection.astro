---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import siteSettings from "../../content/settings/site.json";

const eventos = (await getCollection("agenda"))
  .sort((a, b) => new Date(a.data.fecha).getTime() - new Date(b.data.fecha).getTime())
  .filter((evento) => new Date(evento.data.fecha) >= new Date()); // Solo eventos futuros (opcional)

const formatFecha = (date: Date) => {
    return new Date(date).toLocaleDateString('es-AR', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
}
---

<section class="section bg-dark text-white" id="agenda">
  <div class="container">
    <div class="section-header">
      <h2 class="section-title text-accent">Agenda Cultural</h2>
      <p class="section-subtitle text-white-50">
        Próximos eventos, funciones y muestras. ¡Agendalo!
      </p>
    </div>

    {eventos.length > 0 ? (
      <div class="grid-3">
        {eventos.map((evento) => (
          <article class="card agenda-card">
            <div class="card-image">
              <Image src={evento.data.imagen} alt={evento.data.titulo} />
            </div>
            <div class="card-content">
                <div class="date-badge">{formatFecha(evento.data.fecha)}</div>
              <h3 class="card-title text-accent">{evento.data.titulo}</h3>
              
              <div class="event-meta">
                {evento.data.lugar && <div class="meta-row"><span class="label">Lugar:</span> {evento.data.lugar}</div>}
                {evento.data.precio && <div class="meta-row"><span class="label">Precio:</span> {evento.data.precio}</div>}
                <div class={`status-badge status-${evento.data.estado.toLowerCase().replace(' ', '-')}`}>
                  {evento.data.estado}
                </div>
              </div>

              <p>{evento.data.descripcion}</p>
              <div class="card-actions">
                {evento.data.estado === 'Finalizado' || evento.data.estado === 'Suspendido' ? (
                   <span class="btn-disabled">Evento {evento.data.estado}</span>
                ) : (
                  <a
                    href={`https://wa.me/${evento.data.whatsapp_ventas || siteSettings.whatsapp}?text=Hola, quiero comprar entrada para: ${evento.data.titulo}`}
                    class="btn-buy-ticket"
                    target="_blank"
                  >
                    {evento.data.texto_boton || "Comprar Entrada"}
                  </a>
                )}
              </div>
            </div>
          </article>
        ))}
      </div>
    ) : (
      <p class="text-center text-white-50">No hay eventos programados por el momento.</p>
    )}
  </div>
</section>

<style is:global>
  .agenda-card {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .agenda-card .card-image {
    aspect-ratio: 4/5;
    overflow: hidden;
    background-color: var(--color-neutral-900);
    position: relative;
    flex-shrink: 0;
  }

  .agenda-card .card-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.5s ease;
  }

  .agenda-card:hover .card-image img {
    transform: scale(1.03);
  }

  .agenda-card .card-content {
    padding: var(--space-4);
    background-color: var(--color-surface);
    display: flex;
    flex-direction: column;
    flex: 1; /* Occupy remaining space */
    border-top: 4px solid var(--color-primary-600); /* Visual separator */
    min-width: 0; /* Crucial para el wrap de texto en flexbox */
  }

  .agenda-card .card-title {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-2);
    overflow-wrap: break-word;
    word-break: break-word;
    display: block;
    width: 100%;
  }

  .agenda-card .card-content p {
    margin-bottom: var(--space-4);
    line-height: 1.6;
    overflow-wrap: anywhere; /* Más agresivo que break-word */
    word-break: normal;
    color: var(--color-text-secondary);
    display: block;
    width: 100%;
    max-width: 100%;
    white-space: normal; /* Asegura que no sea nowrap */
  }

  .date-badge {
    background-color: var(--color-primary-600);
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: bold;
    width: fit-content;
    margin-bottom: var(--space-2);
  }

  .card-actions {
    margin-top: auto;
    padding-top: var(--space-4);
    display: flex;
    justify-content: center;
    width: 100%;
  }

  /* Force visibility with high specificity */
  .agenda-card .btn-buy-ticket {
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    padding: 10px 20px !important;
    background-color: transparent !important;
    border: 2px solid #FFD700 !important; /* Gold */
    color: #FFD700 !important;
    text-decoration: none !important;
    border-radius: 8px !important;
    font-weight: 700 !important;
    text-transform: uppercase;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 1 !important;
    visibility: visible !important;
  }

  .agenda-card .btn-buy-ticket:hover {
    background-color: #FFD700 !important;
    color: #000000 !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    transform: translateY(-2px);
  }

  .label {
    font-weight: bold;
    color: var(--color-accent-400); /* Gold */
  }

  /* Nuevos estilos para metadatos */
  .event-meta {
    margin-bottom: var(--space-4);
    font-size: 0.9rem;
    color: var(--color-neutral-300);
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .meta-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .status-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
    text-transform: uppercase;
    width: fit-content;
    margin-top: 0.3rem;
  }

  .status-próximamente { background-color: var(--color-primary-600); color: white; }
  .status-en-curso { background-color: #28a745; color: white; }
  .status-finalizado { background-color: #6c757d; color: white; }
  .status-suspendido { background-color: #dc3545; color: white; }

  .btn-disabled {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 20px;
    background-color: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.5);
    border-radius: 8px;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.9rem;
    cursor: not-allowed;
  }
</style>
