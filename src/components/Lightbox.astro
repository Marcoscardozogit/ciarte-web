---
---
<dialog id="lightbox-modal" class="lightbox-modal">
  <div class="lightbox-container">
    <!-- Top Bar -->
    <div class="lightbox-header">
      <span id="lightbox-counter" class="lightbox-counter"></span>
      <button id="lightbox-close" class="lightbox-btn close-btn" aria-label="Cerrar">×</button>
    </div>

    <!-- Main Content -->
    <div class="lightbox-body">
      <button id="lightbox-prev" class="lightbox-btn nav-btn prev-btn" aria-label="Anterior">‹</button>
      
      <div class="lightbox-media-wrapper">
        <img id="lightbox-image" class="lightbox-image" src="" alt="" />
        <p id="lightbox-caption" class="lightbox-caption"></p>
      </div>

      <button id="lightbox-next" class="lightbox-btn nav-btn next-btn" aria-label="Siguiente">›</button>
    </div>
  </div>
</dialog>

<script>
  // --- VARIABLES GLOBALES DEL MÓDULO ---
  let dialog: HTMLDialogElement | null = null;
  let imageEl: HTMLImageElement | null = null;
  let captionEl: HTMLElement | null = null;
  let counterEl: HTMLElement | null = null;
  
  let galleryItems: { src: string; alt: string }[] = [];
  let currentIndex = 0;

  // --- FUNCIONES DE UPDATE Y CONTROL ---
  
  function updateImage(index: number) {
    if (!imageEl || !captionEl || !counterEl || !galleryItems.length) return;
    
    if (index < 0) index = galleryItems.length - 1;
    if (index >= galleryItems.length) index = 0;

    currentIndex = index;
    const item = galleryItems[currentIndex];
    
    // Transición simple
    if (imageEl) {
        imageEl.style.opacity = '0.5';
        setTimeout(() => {
            if (imageEl) {
                imageEl.src = item.src;
                imageEl.alt = item.alt;
                imageEl.style.opacity = '1';
            }
            if (captionEl) captionEl.textContent = item.alt;
            if (counterEl) counterEl.textContent = `${currentIndex + 1} / ${galleryItems.length}`;
        }, 150);
    }
  }

  function refreshGalleryItems() {
     const links = document.querySelectorAll('a[data-lightbox]');
     galleryItems = Array.from(links).map(link => {
       const img = link.querySelector('img');
       return {
         src: link.getAttribute('href') || img?.getAttribute('src') || '',
         alt: link.getAttribute('data-caption') || img?.getAttribute('alt') || ''
       };
     }).filter(i => i.src);
     return links; 
  }

  function openLightbox(index: number) {
    if (!dialog) return;
    refreshGalleryItems();
    
    updateImage(index);
    try {
        dialog.showModal();
    } catch(e) {
        console.warn("Dialog already open or error", e);
    }
    
    document.body.style.overflow = 'hidden';
    
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    // UI Update
    if (galleryItems.length <= 1) {
       if (prevBtn) prevBtn.style.display = 'none';
       if (nextBtn) nextBtn.style.display = 'none';
       if (counterEl) counterEl!.style.display = 'none';
    } else {
       if (prevBtn) prevBtn.style.display = 'flex';
       if (nextBtn) nextBtn.style.display = 'flex';
       if (counterEl) counterEl!.style.display = 'block';
    }

    // Historial seguro: Solo pushear si no estamos ya "en lightbox"
    if (!history.state || !history.state.lightboxOpen) {
        history.pushState({ lightboxOpen: true }, '', '#lightbox');
    }
  }

  function closeLightbox() {
    if (!dialog) return;
    dialog.close();
    document.body.style.overflow = '';
    
    // Solo volver atrás si REALMENTE tenemos ese estado
    // Si el usuario recargó la página con el lightbox abierto, el history.back() podría sacarlo del sitio.
    // Verificamos el estado actual.
    if (history.state && history.state.lightboxOpen) {
        history.back();
    } else {
        // Si no hay estado (ej: recarga), solo limpiamos la URL si quedó con #lightbox
        if (window.location.hash === '#lightbox') {
            history.replaceState(null, '', ' ');
        }
    }
  }

  // --- HANDLERS ESTABLES (DEFINIDOS SOLO UNA VEZ) ---
  // Al estar fuera de setupLightbox, mantienen su referencia y removeEventListener funciona.

  const handleLinkClick = (e: MouseEvent) => {
    const target = e.target as HTMLElement;
    const link = target.closest('a[data-lightbox]');
    
    if (link) {
      // INTERCEPTAR TODO
      e.preventDefault(); 
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const allLinks = refreshGalleryItems();
      // Encontrar índice basado en la lista visual actual
      let index = Array.from(allLinks).indexOf(link);
      
      if (index === -1) {
          // Fallback por si la referencia cambió (shadow dom, etc)
          const src = link.getAttribute('href');
          index = galleryItems.findIndex(i => i.src === src);
      }
      
      if (index !== -1) openLightbox(index);
    }
  };

  const handleKeydown = (e: KeyboardEvent) => {
      if (!dialog?.open) return;
      if (e.key === 'ArrowLeft') updateImage(currentIndex - 1);
      if (e.key === 'ArrowRight') updateImage(currentIndex + 1);
      if (e.key === 'Escape') closeLightbox();
  };

  const handlePopState = (e: PopStateEvent) => {
      // Si navegamos Atrás y el dialog está abierto, cerrarlo visualmente
      // (Porque el back() ya ocurrió en el navegador)
      if ((!e.state || !e.state.lightboxOpen) && dialog?.open) {
          dialog.close();
          document.body.style.overflow = '';
      }
  };
  
  // Botones internos (estables)
  const handlePrev = (e: Event) => { e.stopPropagation(); updateImage(currentIndex - 1); };
  const handleNext = (e: Event) => { e.stopPropagation(); updateImage(currentIndex + 1); };
  const handleClose = (e: Event) => { e.stopPropagation(); closeLightbox(); };
  const handleDialogClick = (e: MouseEvent) => { if (e.target === dialog) closeLightbox(); };

  // --- SETUP ---
  function setupLightbox() {
    dialog = document.getElementById('lightbox-modal') as HTMLDialogElement;
    imageEl = document.getElementById('lightbox-image') as HTMLImageElement;
    captionEl = document.getElementById('lightbox-caption');
    counterEl = document.getElementById('lightbox-counter');
    
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    if (!dialog) return;

    // Listeners de UI (limpiar y poner)
    // Es seguro remover aunque no exista el listener previo en ese elemento exacto (porque clonamos o recreamos el DOM)
    // Pero si Astro preserva el DOM, es vital limpiar.
    
    closeBtn?.removeEventListener('click', handleClose);
    closeBtn?.addEventListener('click', handleClose);
    
    prevBtn?.removeEventListener('click', handlePrev);
    prevBtn?.addEventListener('click', handlePrev);
    
    nextBtn?.removeEventListener('click', handleNext);
    nextBtn?.addEventListener('click', handleNext);
    
    dialog.onclick = handleDialogClick;

    // Listeners Globales (Documento/Ventana)
    // AQUI ES LA CLAVE: Usar la referencia estable 'handleLinkClick'
    document.removeEventListener('click', handleLinkClick, true);
    document.addEventListener('click', handleLinkClick, true);
    
    document.removeEventListener('keydown', handleKeydown);
    document.addEventListener('keydown', handleKeydown);
    
    window.removeEventListener('popstate', handlePopState);
    window.addEventListener('popstate', handlePopState);
    
    console.log("ciążte Lightbox Initialized (v4 Stable)");
  }

  // Ejecutar
  setupLightbox();
  document.addEventListener('astro:page-load', setupLightbox);
  document.addEventListener('astro:after-swap', setupLightbox);
</script>

<style>
  /* Global Trigger Styles */
  :global(.lightbox-trigger) { 
    display: block; 
    width: 100%; 
    height: 100%; 
    cursor: zoom-in; 
  }
  :global(.lightbox-trigger img) { 
    transition: transform 0.3s ease; 
  }
  :global(.lightbox-trigger:hover img) { 
    transform: scale(1.05); 
  }

  /* Modal Base */
  .lightbox-modal {
    padding: 0;
    border: none; 
    background: transparent;
    width: 100%; 
    height: 100%; 
    max-width: 100vw; 
    max-height: 100vh;
    margin: 0;
  }
  
  .lightbox-modal::backdrop { 
    background: rgba(0, 0, 0, 0.95); 
    backdrop-filter: blur(5px); 
  }

  /* Layout Container */
  .lightbox-container {
    display: flex; 
    flex-direction: column; 
    height: 100%; 
    width: 100%;
  }

  /* Header (Counter + Close) */
  .lightbox-header {
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    padding: 15px 20px;
    color: white;
    position: absolute; /* Overlay on top */
    top: 0;
    left: 0;
    width: 100%;
    z-index: 20;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
  }

  .lightbox-counter { 
    font-family: monospace; 
    font-size: 1.1rem; 
    opacity: 0.8;
  }

  /* Main Body (Arrows + Image) */
  .lightbox-body {
    flex: 1; 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    overflow: hidden; 
    position: relative;
    width: 100%;
    height: 100%;
  }

  .lightbox-media-wrapper {
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
    height: 100%; 
    padding: 0;
    position: relative;
  }

  .lightbox-image {
    max-width: 100%; 
    max-height: 100%;
    object-fit: contain;
    transition: opacity 0.15s ease;
    user-select: none;
  }

  .lightbox-caption {
    color: #e0e0e0; 
    margin-top: 15px; 
    text-align: center;
    font-size: 1rem;
    position: absolute;
    bottom: 20px;
    background: rgba(0,0,0,0.6);
    padding: 5px 15px;
    border-radius: 20px;
    backdrop-filter: blur(4px);
  }

  /* Buttons */
  .lightbox-btn {
    background: none; 
    border: none; 
    color: white; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: color 0.2s, background 0.2s;
    user-select: none;
    outline: none;
  }

  .close-btn {
    font-size: 2.5rem; 
    width: 40px; 
    height: 40px; 
    line-height: 1;
    z-index: 30;
  }
  .close-btn:hover { color: #ff4444; }

  .nav-btn {
    font-size: 3rem; 
    width: 60px;
    height: 100px; /* Hit area height */
    color: rgba(255,255,255,0.7);
    z-index: 20;
  }
  .nav-btn:hover { 
    color: white; 
    background: rgba(255,255,255,0.05); 
    border-radius: 8px;
  }
  .prev-btn { margin-left: 10px; }
  .next-btn { margin-right: 10px; }

  /* Mobile Adjustments */
  @media (max-width: 768px) {
    .nav-btn { 
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 80px;
        background: rgba(0,0,0,0.2);
        border-radius: 50%; /* Circleish hit area */
        font-size: 2rem;
    }
    .prev-btn { left: 10px; }
    .next-btn { right: 10px; }
    
    .lightbox-caption {
        bottom: 10px;
        font-size: 0.9rem;
        max-width: 80%;
    }
  }
</style>
