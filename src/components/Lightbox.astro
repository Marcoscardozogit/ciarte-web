<dialog id="lightbox-modal" class="lightbox-modal">
  <div class="lightbox-content">
    <img id="lightbox-image" class="lightbox-image" src="" alt="" />
    <p id="lightbox-caption" class="lightbox-caption"></p>
  </div>
</dialog>

<script>
  function setupLightbox() {
    const dialog = document.getElementById('lightbox-modal') as HTMLDialogElement;
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
    const lightboxCaption = document.getElementById('lightbox-caption');

    if (!dialog || !lightboxImage) return;

    // --- Funciones de Control ---
    const openLightbox = (src, alt) => {
      lightboxImage.src = src;
      lightboxImage.alt = alt;
      if (lightboxCaption) lightboxCaption.textContent = alt || '';
      
      dialog.showModal();
      document.body.style.overflow = 'hidden';
      // Solo agregar al historial si no estamos ya en ese estado (prevención)
      if (!history.state || !history.state.lightboxOpen) {
        history.pushState({ lightboxOpen: true }, '', '#lightbox');
      }
    };

    const closeLightbox = () => {
      dialog.close();
      document.body.style.overflow = '';
      setTimeout(() => { if(lightboxImage) lightboxImage.src = ''; }, 300);
      
      if (history.state && history.state.lightboxOpen) {
        history.back();
      }
    };

    // --- EVENTO LOCAL: CERRAR (Click en el dialog) ---
    // Al adjuntar directamente al elemento, evitamos problemas de referencias obsoletas.
    // El listener muere cuando el elemento se remueve del DOM (al navegar).
    dialog.onclick = (e) => {
      // Ignorar clicks burbujeados desde el contenido si quisiéramos (e.target !== dialog)
      // Pero "click anywhere" significa CUALQUIER click cierra.
      
      // EXCEPCIÓN IMPORTANTE: Si hacemos click y soltamos (click completo), cerrar.
      // Prevenir acciones por defecto si es necesario.
      e.stopPropagation(); 
      
      if (history.state && history.state.lightboxOpen) {
        history.back();
      } else {
        closeLightbox();
      }
    };

    // --- EVENTO GLOBAL: ABRIR (Delegación para links) ---
    // Este sí debe ser global para capturar cualquier link nuevo o viejo.
    // Para evitar duplicación, usamos una función con nombre y limpieza.
    
    // @ts-ignore
    const handleLinkClick = (e) => {
        const link = e.target.closest('a[data-lightbox]');
        if (link) {
            e.preventDefault();
            const img = link.querySelector('img');
            const src = link.getAttribute('href') || (img && img.getAttribute('src'));
            const alt = link.getAttribute('data-caption') || (img && img.getAttribute('alt')) || '';
            if (src) openLightbox(src, alt);
        }
    };

    // Limpiar anterior (si existía) y asignar nuevo
    // Nota: Como este script corre en cada page-load, document se mantiene, pero queremos reiniciar la lógica.
    document.removeEventListener('click', handleLinkClick);
    document.addEventListener('click', handleLinkClick);

    // --- HISTORY POPSTATE ---
    const handlePopState = (e) => {
        if ((!e.state || !e.state.lightboxOpen) && dialog.open) {
            dialog.close();
            document.body.style.overflow = '';
        }
    };
    window.removeEventListener('popstate', handlePopState);
    window.addEventListener('popstate', handlePopState);
  }

  // Inicialización
  document.addEventListener('astro:page-load', setupLightbox);
  setupLightbox();
</script>

<style>
  /* Triggers style */
  :global(.lightbox-trigger) {
    display: block;
    width: 100%;
    height: 100%;
    cursor: zoom-in;
  }
  
  :global(.lightbox-trigger img) {
    transition: transform 0.3s ease;
  }
  
  :global(.lightbox-trigger:hover img) {
    transform: scale(1.05);
  }

  .lightbox-modal {
    padding: 0;
    border: none;
    background: transparent;
    max-width: 100vw;
    max-height: 100vh;
    width: 100%;
    height: 100%;
    margin: 0;
  }

  /* Backdrop nativo */
  .lightbox-modal::backdrop {
    background: rgba(0, 0, 0, 0.95); /* Más oscuro para mejor contraste */
    backdrop-filter: blur(5px);
  }

  .lightbox-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: relative;
    pointer-events: none; /* Permitir clicks pasen al dialog si no tocan contenido */
  }

  .lightbox-image {
    max-width: 90vw; /* Smaller max width */
    max-height: 80vh; /* Smaller max height to leave room for UI */
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
    opacity: 0;
    transform: scale(0.95);
    transition: opacity 0.3s ease, transform 0.3s ease;
    pointer-events: auto;
    /* Removed z-index to avoid stacking wars, structure handles it */
  }

  @media (max-width: 640px) {
    .lightbox-image {
        max-width: 95vw;
        max-height: 70vh; /* More space for button/caption on mobile */
    }
  }
</style>
